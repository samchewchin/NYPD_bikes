---
title: "datawrangle_NYPDbikes"
author: "Sam Chew Chin"
date: "2025-10-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(stringr)
library(tools)




```
# Read in data
```{r}
#raw
rawdat<-read_csv("data/crashdata.csv")
  
spec(rawdat)

```


```{r rename}

#rename and reformat key variables

crashdat<-rawdat%>%
  mutate(date=mdy(`CRASH DATE`))%>%
  relocate(date)%>%
  rename(time=`CRASH TIME`, 
         lat=LATITUDE,
         lon=LONGITUDE,
         street=`ON STREET NAME`,
         cross=`CROSS STREET NAME`,
         cycle_inj=`NUMBER OF CYCLIST INJURED`,
         cycle_kill=`NUMBER OF CYCLIST KILLED`)


#filter out missing coords, date
crashfilt<-crashdat%>%
    filter(!is.na(lat), 
           !is.na(lon), 
           !is.na(date),
           lon!=0,
           lat!=0)

#rejected data

```

```{r review}

# review
crashfilt%>%
  select(date)%>%
  summary()


crashfilt%>%
  filter(lon==0)


```





```{r app filter}
#strip down to minimal for shiny app
appdat<-crashfilt%>%
  select(date, time, lat, lon, injured=cycle_inj, killed=cycle_kill, street, cross)%>%
 mutate(
    date  = as.Date(date),
    month = as.numeric(format(date, "%m")),
    fancydate = as.character(format(date, "%b %d, %Y")
      )) %>%
  mutate(
    # Clean and title-case street names
    street = street %>%
      str_trim() %>%
      na_if("") %>%
      str_to_title(),
    
    cross = cross %>%
      str_trim() %>%
      na_if("") %>%
      str_to_title()
  ) %>%
  mutate(
    popup_label = sprintf(
      "<b>Date:</b> %s<br><b>Injured:</b> %d<br><b>Killed:</b> %d%s%s",
      fancydate,
      injured,
      killed,
      ifelse(street != "", paste0("<br><b>Street:</b> ", street), ""),
      ifelse(cross != "", paste0("<br><b>Cross:</b> ", cross), "")
    )
  )

# Save final dataset
appdata <- appdat %>%
  select(date, month, lon, lat, injured, killed, popup_label)

write.csv(appdata, "NYPD_Bike_DataDashboard/appdata.csv", row.names = FALSE)
```


```{r dummy data}

dff<-data.frame(
    lon = runif(200, -73.99, -73.90),
    lat = runif(200, 40.70, 40.80),
    injured = sample(0:3, 200, replace = TRUE),
    killed = sample(0:1, 200, replace = TRUE),
    date = Sys.Date() - sample(1:365, 200, replace = TRUE),
    time = sprintf("%02d:%02d", sample(0:23,200,replace=TRUE), sample(0:59,200,replace=TRUE)))


```


```{r check data}
#avg injuries per month
appdat%>%
  mutate(month=month(date), year=year(date))%>%
  group_by(month, year)%>%
  summarise(sum_inj =sum(injured))%>%
  ungroup()%>%
  group_by(month)%>%
  summarise(mean_inj=mean(sum_inj))


```

```{r check data}
#avg kill per month
appdat%>%
  mutate(month=month(date), year=year(date))%>%
  group_by(month, year)%>%
  summarise(sum_kill =sum(killed))%>%
  ungroup()%>%
  group_by(month)%>%
  summarise(mean_kill=mean(sum_kill))


```


# Static maps


```{r maps}

library(sf)

# assuming your data is in a data.frame called df
# with columns lat, lon, injured, killed


map_df<-appdat

# convert to sf object
df_sf <- st_as_sf(map_df, coords = c("lon", "lat"), crs = 4326)

ggplot() +
  geom_sf(data = df_sf[map_df$injured > 0,], aes(color = "Injury"), alpha = 0.7, size = 2) +
  geom_sf(data = df_sf[map_df$killed > 0,], aes(color = "Fatality"), alpha = 0.9, size = 3, shape = 4) +
  scale_color_manual(values = c("Injury" = "limegreen", "Fatality" = "hotpink")) +
  theme_minimal() +
  theme(panel.background = element_rect(fill = "black"))

```
